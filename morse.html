<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Codebusters Fractionated Morse cipher practice">
    <title>Fractionated Morse Practice</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .puzzle-container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .puzzle-container h1 {
            text-align: center;
            color: #1abc9c;
            margin-bottom: 25px;
        }
        
        .input-group {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        #keyword-input {
            padding: 8px;
            border: 2px solid #1abc9c;
            border-radius: 4px;
            text-transform: uppercase;
            font-size: 1.1rem;
            width: 200px;
            text-align: center;
        }

        .cipher-sequence {
            border: 2px solid #1abc9c;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            background-color: #e8f8f5;
            text-align: center;
            font-size: 1.4rem;
            font-weight: bold;
            letter-spacing: 0.2em;
        }

        .decryption-steps {
            margin-top: 30px;
            padding: 20px;
            background: #f7f7f7;
            border-radius: 8px;
        }
        
        .step {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 4px;
            font-family: monospace;
            font-size: 1.1rem;
            word-wrap: break-word;
        }
        
        .step-label {
            font-weight: bold;
            color: #1abc9c;
            display: block;
            margin-bottom: 5px;
        }
        
        .result-text {
            font-size: 1.2rem;
            color: #34495e;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-transform: uppercase;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <a href="index.html" class="logo">Codebusters</a>
            <nav>
                <ul>
                    <li><a href="aristocrat.html">Aristocrat</a></li>
                    <li><a href="patristocrat.html">Patristocrat</a></li>
                    <li><a href="baconian.html">Baconian</a></li>
                    <li><a href="xenocrypt.html">Xenocrypt</a></li>
                    <li><a href="porta.html">Porta</a></li>
                    <li><a href="cryptarithm.html">Cryptarithm</a></li>
                    <li><a href="nihilist.html">Nihilist</a></li>
                    <li><a href="columnar.html">Columnar</a></li>
                    <li><a href="morse.html">Fractionated Morse</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="puzzle-container">
                <h1>Fractionated Morse Cipher Practice</h1>
                <p class="text-center">A three-step cipher: Text → Morse Code → Fractionation → Letter Substitution.</p>
                
                <div class="input-group">
                    <label for="keyword-input">Substitution Keyword:</label>
                    <input type="text" id="keyword-input" placeholder="KEYWORD">
                </div>

                <h2>Ciphertext (Grouped in 3s):</h2>
                <div id="cipher-display" class="cipher-sequence"></div>
                
                <div class="control-area" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
                    <button id="decrypt-button" class="btn btn-primary" style="background-color: #1abc9c;">Decrypt</button>
                    <button id="new-puzzle-button" class="btn btn-secondary" style="background-color: #28a745;">New Puzzle</button>
                    <button id="give-up-button" class="btn btn-secondary" style="background-color: #dc3545;">Show Solution</button>
                </div>
                
                <p id="message-area" style="font-weight: bold; text-align: center; margin-top: 15px;"></p>

                <div class="decryption-steps">
                    <h2>Decryption Steps:</h2>
                    <div id="step-1" class="step"><span class="step-label">Step 1: Ciphertext to Morse Sequence (Substitution Inverse)</span></div>
                    <div id="step-2" class="step"><span class="step-label">Step 2: Defractionation (Grouping into 3s)</span></div>
                    <div id="step-3" class="step"><span class="step-label">Step 3: Morse Code to Plaintext</span><span class="result-text" id="plaintext-result"></span></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const QUOTES = [
            "THE FRACTIONATED MORSE CIPHER IS A CHALLENGE TO DECRYPT",
            "CIPHERS CAN BE COMPOSED OF MULTIPLE STEPS TO INCREASE SECURITY",
            "DOTS DASHES AND X MARKS ARE USED IN MORSE CODE FRACTIONATION",
            "ALL MORSE CODE SEQUENCES ARE GROUPED INTO BLOCKS OF THREE"
        ];
        
        // Morse Code (Letter -> Code)
        const MORSE_ENCODE = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.', 
            'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..', 
            'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.', 
            'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-', 
            'Y': '-.--', 'Z': '--..'
        };
        // Morse Code (Code -> Letter)
        const MORSE_DECODE = {};
        for (const [key, value] of Object.entries(MORSE_ENCODE)) { MORSE_DECODE[value] = key; }

        // Fractionation Tableau (3-bit sequence -> Substitution Letter)
        const FRACTIONATION_TABLE = 'ATBLOCURDFEZYQWVXSKGNIHJM P'; 
        // Note: The original 27-char table maps 27 3-bit sequences (. / -) to A-Z + Punctuation
        // . -> A, .. -> B, ... -> C, .... -> D, ..... -> E, ...... -> F, ......X -> G
        // Standard Codebusters table is A-Z plus space ('P')
        // Sequences: .--. .--X .--.X .--.-.X
        
        // For simplicity and alignment with a 27-char substitution keyword:
        // We use . (dot), - (dash), X (separator/space) as the three symbols.
        // There are 3*3*3 = 27 possible trigrams (XXX, XX-, XX., ... ---)
        
        let currentPlaintext = ''; 
        let morseSequence = '';
        let fractionatedSequence = ''; // Grouped into 3s
        let substitutionKeyword = '';
        
        const cipherDisplay = document.getElementById('cipher-display');
        const keywordInput = document.getElementById('keyword-input');
        const plaintextResult = document.getElementById('plaintext-result');
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const step3 = document.getElementById('step-3');
        const messageArea = document.getElementById('message-area');

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('decrypt-button').addEventListener('click', decryptMorse);
            document.getElementById('new-puzzle-button').addEventListener('click', generateNewPuzzle);
            document.getElementById('give-up-button').addEventListener('click', showSolution);
            generateNewPuzzle();
        });

        function normalizeText(text) {
            return text.toUpperCase().replace(/[^A-Z]/g, '');
        }

        /**
         * Generates the Morse dot/dash/x sequence from plaintext.
         */
        function generateMorseSequence(plain) {
            let morse = '';
            for (let i = 0; i < plain.length; i++) {
                const char = plain[i];
                if (MORSE_ENCODE[char]) {
                    morse += MORSE_ENCODE[char];
                    if (i < plain.length - 1) {
                        morse += 'X'; // Letter separator
                    }
                }
            }
            return morse;
        }

        /**
         * Pads the Morse sequence with trailing dots to make its length divisible by 3.
         */
        function padMorseSequence(morse) {
            while (morse.length % 3 !== 0) {
                morse += '.';
            }
            return morse;
        }

        /**
         * Generates the 27 trigrams from '...' to '---'.
         * @returns {string[]} Array of 27 trigrams.
         */
        function generateTrigrams() {
            const symbols = ['.', '-', 'X'];
            const trigrams = [];
            for (const s1 of symbols) {
                for (const s2 of symbols) {
                    for (const s3 of symbols) {
                        trigrams.push(s1 + s2 + s3);
                    }
                }
            }
            return trigrams; // 27 trigrams
        }

        /**
         * Encodes the Morse sequence into the final ciphertext using a substitution keyword.
         */
        function encodeFractionatedMorse(morse, key) {
            const paddedMorse = padMorseSequence(morse);
            const trigrams = generateTrigrams();
            
            // Build the substitution map (Trigram -> Cipher Char)
            const substitutionMap = {};
            const keySequence = key.toUpperCase().replace(/[^A-Z]/g, '');
            const subAlphabet = keySequence + ALPHABET.split('').filter(c => !keySequence.includes(c)).join('');
            
            for (let i = 0; i < trigrams.length && i < subAlphabet.length; i++) {
                substitutionMap[trigrams[i]] = subAlphabet[i];
            }

            let cipher = '';
            for (let i = 0; i < paddedMorse.length; i += 3) {
                const trigram = paddedMorse.substring(i, i + 3);
                cipher += substitutionMap[trigram] || '?'; // Should always find a match
            }
            
            return cipher;
        }

        /**
         * Main decryption function.
         */
        function decryptMorse() {
            const cipher = normalizeText(cipherDisplay.textContent.replace(/\s/g, ''));
            const key = keywordInput.value.toUpperCase().replace(/[^A-Z]/g, '');

            if (!key || cipher.length === 0 || cipher.length % 3 !== 0) {
                 messageArea.textContent = "Error: Please provide a Keyword and a valid ciphertext (length divisible by 3).";
                 messageArea.style.color = '#dc3545';
                 return;
            }

            // 1. Setup Substitution Inverse Map
            const trigrams = generateTrigrams();
            const subAlphabet = key + ALPHABET.split('').filter(c => !key.includes(c)).join('');
            
            const inverseSubMap = {}; // Cipher Char -> Trigram
            for (let i = 0; i < trigrams.length && i < subAlphabet.length; i++) {
                inverseSubMap[subAlphabet[i]] = trigrams[i];
            }

            // 2. Step 1: Substitution Inverse (Ciphertext to Fractionated Morse)
            let fractionatedMorse = '';
            let step1Output = '';
            for (const char of cipher) {
                const trigram = inverseSubMap[char];
                if (!trigram) {
                    messageArea.textContent = `Error: Cipher character '${char}' is not in the substitution alphabet.`;
                    messageArea.style.color = '#dc3545';
                    return;
                }
                fractionatedMorse += trigram;
                step1Output += trigram + ' ';
            }
            step1.innerHTML = `<span class="step-label">Step 1: Ciphertext to Morse Sequence (Substitution Inverse)</span>${step1Output}`;
            
            // 3. Step 2: Defractionation (Remove padding and group into Morse letters)
            let rawMorse = '';
            // Remove trailing dots (padding) used to make length divisible by 3
            // Since the plaintext always ends with a letter, the padding must be all dots at the end
            let trimmedMorse = fractionatedMorse;
            while (trimmedMorse.length > 0 && trimmedMorse.endsWith('.')) {
                // Heuristically remove padding dots one by one
                trimmedMorse = trimmedMorse.slice(0, -1);
            }
            rawMorse = trimmedMorse;
            
            let step2Output = '';
            // Group the raw morse code by 'X' separators
            const morseLetters = rawMorse.split('X').filter(m => m.length > 0);
            step2Output += morseLetters.map(m => `[${m}]`).join(' ');
            
            step2.innerHTML = `<span class="step-label">Step 2: Defractionation (Grouping into Morse Letters)</span>${step2Output}`;
            
            // 4. Step 3: Morse Code to Plaintext
            let plaintext = '';
            for (const morseCode of morseLetters) {
                plaintext += MORSE_DECODE[morseCode] || '?';
            }
            
            plaintextResult.textContent = plaintext.split('').join(' ');
            step3.innerHTML = `<span class="step-label">Step 3: Morse Code to Plaintext</span><span class="result-text">${plaintext.split('').join(' ')}</span>`;
            
            messageArea.textContent = 'Decryption steps completed.';
            messageArea.style.color = '#1abc9c';
        }

        /**
         * Generates a new random puzzle for practice.
         */
        function generateNewPuzzle() {
            const quote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
            currentPlaintext = normalizeText(quote);
            
            // Generate a random key (unique 5-10 letters)
            const keyLength = Math.floor(Math.random() * 6) + 5; 
            let randomKey = '';
            while (randomKey.length < keyLength) {
                const char = ALPHABET[Math.floor(Math.random() * 26)];
                if (!randomKey.includes(char)) {
                    randomKey += char;
                }
            }
            substitutionKeyword = randomKey;
            
            morseSequence = generateMorseSequence(currentPlaintext);
            currentCiphertext = encodeFractionatedMorse(morseSequence, substitutionKeyword);
            
            keywordInput.value = substitutionKeyword;
            cipherDisplay.textContent = currentCiphertext.match(/.{1,3}/g).join(' '); // Group into 3-letter blocks
            
            step1.innerHTML = `<span class="step-label">Step 1: Ciphertext to Morse Sequence (Substitution Inverse)</span>`;
            step2.innerHTML = `<span class="step-label">Step 2: Defractionation (Grouping into 3s)</span>`;
            step3.innerHTML = `<span class="step-label">Step 3: Morse Code to Plaintext</span><span class="result-text" id="plaintext-result"></span>`;
            plaintextResult.textContent = '...';

            messageArea.textContent = 'New puzzle loaded. Enter the correct keyword to decrypt.';
            messageArea.style.color = '#007bff';
        }

        /**
         * Shows the solution by filling the correct keyword and running decryption.
         */
        function showSolution() {
            keywordInput.value = substitutionKeyword;
            decryptMorse();
            messageArea.textContent = 'Solution revealed. The full decryption process is shown.';
            messageArea.style.color = '#dc3545';
        }
    </script>
</body>
</html>